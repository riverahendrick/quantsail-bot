# Changelog — Quantsail

## Unreleased
- 2026-02-07: **100% Test Coverage — Coverage Gaps Closed**: Created `test_coverage_gaps.py` with 26 tests covering previously untouched lines across 13 modules. Fixed 7 test failures (MetricsCalculator API mismatch, DynamicSizer max-cap math, BinanceAdapter ccxt-is-None guard, BacktestExecutor nested return shape, DataFetcher datetime filtering, CryptoPanic NewsArticle `kind` field). Modules covered: `metrics.py`, `dynamic_sizer.py`, `trailing_stop.py`, `vwap_reversion.py`, `binance_adapter.py`, `executor.py`, `main.py`, `sentry_service.py`, `data_fetcher.py`, `market_provider.py`, `cryptopanic.py`, `monte_carlo.py`, `runner.py`. Cleaned up temp test output files.
- 2026-02-07: **Profitability Enhancement — Risk Management & Strategy Expansion**: Major upgrade to the trading engine's profitability and risk control capabilities.
  - **New Indicators**: Added VWAP (Volume Weighted Average Price), MACD (Moving Average Convergence Divergence), and OBV (On-Balance Volume) with full test coverage.
  - **New Strategy**: Added VWAP Mean Reversion strategy with configurable deviation thresholds, volume confirmation, and OBV trend filtering. Integrated as the 4th strategy in the EnsembleCombiner.
  - **Dynamic Position Sizing**: Replaced hardcoded quantities with `DynamicSizer` (ATR-based volatility-adjusted sizing with configurable risk-per-trade and max position caps).
  - **Configurable SL/TP**: Replaced hardcoded stop-loss and take-profit with `StopLossConfig` (ATR-multiplier based) and `TakeProfitConfig` (reward-to-risk ratio based).
  - **Trailing Stop-Loss**: Integrated `TrailingStopManager` into the trading loop's `IN_POSITION` state (ATR-based trailing with configurable activation threshold and step size).
  - **Configuration Models**: Added `VWAPStrategyConfig`, `DynamicSizingConfig`, `StopLossConfig`, `TakeProfitConfig`, `TrailingStopConfig` to `BotConfig`.
  - **Test Fixes**: Updated ensemble strategy count assertions (3→4 strategies), fixed Pydantic validation constraints in tests (`min_agreement`, `atr_filter_mult`).
  - **SL/TP Calibration**: Calibrated risk parameters across 4 rounds. Selected **SL 2.5 ATR / R:R 2.0** as the optimal configuration to balance win rate and risk-reward ratio, overcoming 5m timeframe fee drag. Adjusted Conservative profile threshold to 0.30 to ensure trade execution.
- 2026-01-28: **Complete Dashboard Redesign - Modern Trading Terminal Aesthetic**: Complete overhaul of both public and private dashboards with a modern, polished trading terminal design. Created new `NeoCard` component system with enhanced glassmorphism, neon accent colors, gradient borders, and micro-interactions. Redesigned all public pages (Overview, Trades, Transparency) with professional crypto-dashboard aesthetics. Enhanced EquityChart with improved glow effects under the line, shimmer animations, and better gradients. Updated all private dashboard widgets (StatusBanner, KPIGrid, DailyLockWidget, BreakersWidget, RecentTrades) to use the new design system. Added new animations (fade-in, scale-in, slide-in) and improved hover states throughout.
- 2026-01-28: **Database URL Driver**: Switched env templates to `postgresql+psycopg://` to match psycopg3 dependency for Alembic/SQLAlchemy.
- 2026-01-28: **External Service Env Coverage**: Added CryptoPanic and Alpha Vantage placeholders to env templates/local envs and documented key acquisition guidance.
- 2026-01-28: **Engine Test Stabilization**: Added missing risk fields to dry-run trades, expanded stub models for stop/TP, improved LiveExecutor idempotency/reconcile paths, and added adapter/exit coverage to restore 100% engine test coverage.
- 2026-01-28: **Users Admin Page + /app Routes**: Added owner-only Users page in the private dashboard (create/list/update/reset link), added /app/* route aliases to align with UI specs, updated nav to include Users, and added Playwright users page coverage with mock mode enabled for E2E.
- 2026-01-28: **User Management + Key Rotation + DB Key Lookup**: Added owner-only user management endpoints (Firebase user provisioning, role claims, disable/enable). Added exchange key activation/rotation endpoints and dashboard controls. Engine now reads active exchange keys from Postgres (AES-GCM with MASTER_KEY). Added migrations for events.seq and exchange_keys.is_active.
- 2026-01-28: **Git Ignore for Secrets**: Added .gitignore entries for local env files to avoid committing secrets.
- 2026-01-28: **Local Env Files + Phase 1 Kickoff**: Added .env files for dashboard/api/engine with inline key instructions, removed engine artifacts, and created Phase 1 progress tracker.
- 2026-01-28: **Env + Remediation Plan**: Added remediation tracking plan, env templates for dashboard/api/engine, and environment setup guide. Dashboard WebSocket now reads `NEXT_PUBLIC_WS_URL`.
- 2026-01-28: **Dashboard Runtime Fixes**: Removed invalid CardDescription usage, added missing EN/ES i18n keys for Strategy/Risk pages, and improved error/status handling. Updated dashboard config to make USE_MOCK_DATA opt-in via env flags.
- 2026-01-28: **Gap Remediation & Full System Audit**: Conducted forensic audit and closed all critical gaps.
  - **API**: Added missing `v1/config` (versioning), `v1/exchanges` (encrypted keys), and `v1/bot` control endpoints. Implemented `EncryptionService` (AES-GCM).
  - **Engine**: Implemented `LiveExecutor.check_exits` (real market sell logic) and updated repository to persist risk parameters (`stop_price`, `take_profit_price`).
  - **Dashboard**: Created missing pages: Strategy (JSON Editor), Risk (Controls), Exchange (Key Management), and Events (Log). Created shared UI components (`Table`, `Input`, `Label`, `Textarea`) and API client. Full i18n support for new pages.
- 2026-01-27: **ARM LIVE & Live Execution**: Implemented critical safety gates for live trading. Added `POST /v1/bot/arm` (2-step verification) and `POST /v1/bot/start` requiring a short-lived token. Implemented `LiveExecutor` with `BinanceSpotAdapter` (via `ccxt`) ensuring strict idempotency using deterministic `client_order_id`. Added restart reconciliation logic to `TradingLoop` to detect orphaned orders. Dashboard updated with an "ARM LIVE" modal flow. Verified with unit, integration, and E2E tests.
- 2026-01-27: **Public Transparency Dashboard**: Implemented public-facing pages at `/public/*` ensuring full transparency without exposing private data. Features a sanitized Overview with equity curve and KPIs, a real-time (delayed) Trades Feed, and a detailed Transparency Report explaining the bot's safety mechanisms. Built with strict data sanitization logic (no internal IDs/secrets) and validated via E2E tests. Includes responsive mobile-first navigation and i18n support.
- 2026-01-27: **Private Dashboard Overview**: Implemented the operator dashboard at `/app/overview` featuring real-time status banner, KPI grid, Daily Target Lock visualizer, Active Breakers list, and Recent Trades table. Built with modern UI components (Tailwind + Lucide icons), a "trading terminal" dark theme, and an App Shell with sidebar navigation. Includes an `EquityChart` visualization using Recharts. Wired to the backend via WebSocket using `zustand` for state management. Includes `AuthGuard` for route protection (with dev bypass) and full i18n support (EN/ES). Validated with E2E tests using Playwright.
- 2026-01-27: **Daily Target Lock**: Implemented daily profit target enforcement with two modes: STOP (hard stop at target) and OVERDRIVE (trailing profit floor). Added `DailyLockManager`, timezone-aware PnL tracking in `EngineRepository`, and integration into the entry pipeline. Features state persistence via peak PnL reconstruction from trade history. Emits `daily_lock.engaged`, `daily_lock.floor_updated`, and `daily_lock.entries_paused` events. Fully tested with 100% coverage.
- 2026-01-27: **News Pause Integration**: Implemented negative news pause feature with API ingestion endpoint (`POST /v1/news/ingest`), Redis/in-memory cache, and engine integration. Only negative + high-impact news triggers pause. Added endpoints for status check and manual clearing. Integrated with `BreakerManager` to block entries when news pause active (configurable via `config.breakers.news.enabled`). Emits `gate.news.rejected` event. Full test coverage for news cache, endpoints, and engine integration. Exits never blocked.
- 2026-01-27: **Circuit Breakers**: Implemented four circuit breaker types (volatility spike, spread/slippage spike, consecutive losses, exchange instability) that pause entries while allowing exits. Added `BreakerManager` with configurable expiry times, trigger logic with real-time market data checks (ATR multiple, spread_bps, consecutive loss tracking), and event emission (`breaker.triggered`, `breaker.expired`, `gate.breaker.rejected`). Integrated breakers into trading loop EVAL state with proper type checking and 100% test coverage for breaker modules.
- 2026-01-27: **Profitability Gate**: Implemented fee, slippage, and spread estimators using real-time orderbook depth. Updated `ProfitabilityGate` to reject trades below `min_profit_usd` after all estimated costs. Integrated estimators into the `TradingLoop` entry pipeline and added detailed `gate.profitability.passed/rejected` events with full cost breakdowns.
- 2026-01-27: **Strategies & Ensemble**: Implemented Trend (EMA/ADX), Mean Reversion (Bollinger/RSI), and Breakout (Donchian/ATR) strategies. Added pure-Python technical indicators and an EnsembleCombiner that aggregates strategy votes with configurable confidence thresholds. Updated engine loop to emit detailed `signal.generated` and `ensemble.decision` events.
- 2026-01-27: **Engine Dry-Run Core Loop**: Implemented complete trading engine with state machine (IDLE→EVAL→ENTRY_PENDING→IN_POSITION→EXIT_PENDING), deterministic dry-run execution, profitability gate, per-symbol orchestration, equity tracking, and full event emission. Added stub database models for testing, 145 tests passing with 98% coverage. Entry point ready for signal integration.
- 2026-01-27: Added event streaming support with an append-only events repository, WS cursor resume, heartbeat messages, and payload redaction.
- 2026-01-27: Expanded WS coverage for auth/cursor/heartbeat paths and ensured event tests respect trade foreign keys.
- 2026-01-27: Added Firebase JWT auth + RBAC enforcement for private API routes, plus sanitized public endpoints with rate limiting and full test coverage.
- 2026-01-27: Implemented SQLAlchemy models + Alembic migrations for the documented Postgres schema, added DB health endpoint and schema verification tests.
- 2026-01-27: Suppressed root layout hydration mismatches caused by external attributes in the dashboard.
- 2026-01-27: Added dashboard i18n (EN/ES), public overview page, Playwright baseline E2E, and a hardcoded-string guard; configured ruff/mypy/pytest coverage in API and Engine.
- 2026-01-27: Scaffolded dashboard (Next.js), API (FastAPI + uv), and engine (uv package), added local Docker Compose for Postgres/Redis, and introduced basic infra scripts and tests.
- 2026-01-26: Created documentation pack v7. Major expansion of PRD (detailed epics, acceptance criteria, checklists) and implementation guides.

- 2026-01-26: Merged v4 missing docs (security ops, validation, glossary), expanded DB schema explicit columns, merged folder structure and overview.

- 2026-01-26: Preserved v4 documentation files and added compatibility redirect stubs.
